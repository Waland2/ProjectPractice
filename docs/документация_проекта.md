# Документация проекта "tinyjsondb"

## Общее описание

`tinyjsondb` — это библиотека на Python, предназначенная для создания и управления микробазами данных в формате JSON. Она реализует ORM-подобный интерфейс и позволяет работать с моделями данных через декларативный API, схожий с Django ORM.

Библиотека подходит для образовательных целей, CLI-утилит и небольших приложений, где не требуется полноценная СУБД. Данные хранятся в локальных `.json`-файлах, поддерживается автоинкремент первичного ключа, контроль схемы модели и безопасная запись в файл с помощью системы блокировок.

---

## Технический стек

* **Язык программирования:** Python 3.10+
* **Формат хранения:** JSON
* **Механизмы синхронизации:** portalocker (блокировка при записи)
* **Система типов:** пользовательские классы полей (IntegerField, StringField, и др.)

---

## Архитектура проекта

Проект построен модульно и включает следующие компоненты:

* **Model** — базовый класс для всех моделей, отвечает за создание, обновление, удаление объектов и взаимодействие с файловым хранилищем.
* **MetaModel** — метакласс, формирующий схему модели, определяет первичный ключ и инициализирует менеджер объектов.
* **Manager** — интерфейс `objects`, предоставляющий доступ к CRUD-операциям: `create`, `get`, `update`, `delete`, `all`, `clear`.
* **Field-типизация** — поля модели определяются с помощью классов `BaseField`, `IntegerField`, `StringField`, `AutoField`, `DictField`, `ListField`.
* **JSON-сериализация** — используется модуль `json` для чтения и записи в файл, поддерживается безопасная запись с помощью `NamedTemporaryFile` и `os.replace`.
* **Блокировка при записи** — реализована с помощью `portalocker`, предотвращает одновременное изменение файла из разных процессов.

---

## Основные функции

### Декларативное описание моделей

```python
class User(Model):
    id = IntegerField(primary_key=True)
    name = StringField()
    age = IntegerField()

User.sync()
User.objects.create(name="Alice", age=30)
```

### Поддержка CRUD-операций

* `create(**kwargs)` — создать объект
* `get(**kwargs)` — получить объект по фильтру
* `update()` — обновить поля объекта
* `delete()` — удалить объект
* `all()` — получить все объекты

### Автоматическое управление схемой

Метод `sync()` добавляет отсутствующие поля в JSON-файл, удаляет лишние ключи, проверяет наличие первичного ключа и формирует пустую структуру при первом запуске.

---

## Конфигурация модели и хранения

* Путь к JSON-файлу генерируется автоматически по имени класса, например: `User -> User.json`
* Первичный ключ назначается автоматически, если не задан явно
* Данные сериализуются и десериализуются с сохранением структуры и типов

---

## Обработка ошибок

В проекте реализована система пользовательских исключений для различных случаев:

* `MissingPrimaryKeyError` — отсутствует первичный ключ
* `DuplicatePrimaryKeyError` — запись с таким PK уже существует
* `ObjectNotFoundError` — объект не найден
* `FieldDoesNotExistError` — обращение к несуществующему полю
* `MissingPrimaryKeyInObjectError` — не задан PK при создании объекта

---

## Безопасность

В библиотеке реализованы базовые механизмы безопасности работы с данными:

* Защита от одновременной записи: `portalocker` блокирует файл на запись
* Атомарная запись: используется временный файл + `os.replace`
* Защита от ошибок сериализации: структура файла проверяется методом `sync()`
* Контроль схемы модели: синхронизация полей и типов при каждом запуске

---

## Вывод

`tinyjsondb` демонстрирует, как можно реализовать микробазу данных на JSON с нуля без использования сторонних ORM. Проект охватывает темы сериализации, работы с файлами, метапрограммирования и проектирования интерфейсов. Благодаря компактности и читаемому API, он может использоваться как учебный пример и как легковесное хранилище данных для небольших проектов.
